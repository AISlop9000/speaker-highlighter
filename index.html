<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Speaker Highlighter v3.13</title>
<style>
body { font-family: Arial, sans-serif; margin:20px; background:#fafafa; color:#111; }
textarea { width:100%; height:220px; font-size:16px; padding:10px; margin-bottom:10px; font-family: monospace; }
button { margin:4px; padding:6px 10px; border:none; border-radius:6px; cursor:pointer; background:#444; color:white; }
button:hover { background:#222; }
input[type=color] { margin-left:4px; margin-right:10px; cursor:pointer; }
#controls { display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:10px; }
#output { white-space:pre-wrap; background:white; padding:12px; border-radius:8px; min-height:200px; overflow:auto; }
.highlight { display:block; margin:6px 0; border-radius:4px; padding:2px 4px; }
.speaker { font-weight:bold; text-transform:uppercase; }
#speakerControls { margin-bottom:10px; }
#legend { margin-bottom:10px; display:flex; flex-wrap:wrap; gap:8px; }
.legend-item { padding:4px 8px; border-radius:4px; color:white; font-weight:bold; display:flex; align-items:center; gap:4px; }
.spotlight-btn { background:#f0a500; color:#000; margin-left:4px; }
</style>
</head>
<body>

<h1>ðŸŽ­ Speaker Highlighter v3.13</h1>

<textarea id="scriptInput" placeholder="Paste your script here..."></textarea>

<div id="controls">
  <button onclick="detectSpeakers()">Detect Speakers</button>
  <button onclick="highlightScript()">Highlight Speakers</button>
  <button onclick="toggleAllSpeakers()">Toggle All</button>
  <button onclick="copyForDocs()">Copy for Docs</button>
  <button onclick="copyText()">Copy Text</button>
  <label>Font size: <input id="fontSize" type="range" min="12" max="32" value="16" oninput="updateFontSize(this.value)"> <span id="fontSizeVal">16</span>pt</label>
</div>

<div id="legend"></div>
<div id="speakerControls"></div>
<hr>
<div id="output"></div>

<script>
const speakerColors = {};
const vividColors = ['#e6194b','#3cb44b','#ffe119','#4363d8','#f58231','#911eb4','#46f0f0','#f032e6','#bcf60c','#fabebe','#008080','#e6beff','#9a6324','#fffac8','#800000'];
let detectedSpeakers = [];
let toggled = {};
let spotlighted = null; // Currently spotlighted speaker

document.getElementById("fontSize").addEventListener('input', e => updateFontSize(e.target.value));

function detectSpeakers(){
  const text = document.getElementById("scriptInput").value;
  const matches = [...text.matchAll(/^([A-Za-z0-9 .'-]+):/gm)];
  detectedSpeakers = [...new Set(matches.map(m => m[1].trim()))];
  detectedSpeakers.forEach((sp,i)=>{
    if(!speakerColors[sp]) speakerColors[sp] = vividColors[i % vividColors.length];
    if(toggled[sp]===undefined) toggled[sp] = true;
  });
  renderSpeakerControls();
  renderLegend();
  highlightScript();
}

function renderSpeakerControls(){
  const div = document.getElementById("speakerControls");
  div.innerHTML = "<strong>Speakers:</strong><br>";
  detectedSpeakers.forEach(sp=>{
    div.innerHTML += `<label>
      <input type="checkbox" data-sp="${sp}" ${toggled[sp]?'checked':''}> 
      <span style="color:${speakerColors[sp]}">${sp}</span>
      <input type="color" value="${speakerColors[sp]}" data-sp="${sp}" onchange="changeSpeakerTextColor(this)">
      <button class="spotlight-btn" data-sp="${sp}" onclick="setSpotlight(this)">Spotlight</button>
    </label> `;
  });
  div.querySelectorAll('input[type=checkbox]').forEach(cb=>{
    cb.onchange=e=>{ toggled[e.target.dataset.sp]=e.target.checked; highlightScript(); };
  });
}

function setSpotlight(button){
  const sp = button.dataset.sp;
  if(spotlighted === sp) spotlighted = null; // toggle off if already spotlighted
  else spotlighted = sp;
  highlightScript();
}

function changeSpeakerTextColor(input){
  const sp = input.dataset.sp;
  speakerColors[sp] = input.value;
  renderLegend();
  highlightScript();
}

function renderLegend(){
  const div = document.getElementById("legend");
  div.innerHTML = '';
  detectedSpeakers.forEach(sp=>{
    const color = speakerColors[sp];
    const item = document.createElement('div');
    item.className='legend-item';
    item.style.background=color;
    item.innerText=sp;
    div.appendChild(item);
  });
}

function highlightScript(){
  const text = document.getElementById("scriptInput").value;
  const lines = text.split('\n');
  const font = parseInt(document.getElementById("fontSize").value);
  const reducedFont = Math.round(font * 0.7);

  const out = lines.map(line=>{
    const sceneMatch = line.match(/^\{SCENE\}/i);
    if(sceneMatch) 
      return `<div style="text-align:center; font-size:${font}px; font-weight:bold; margin-top:20px; margin-bottom:20px;">
                SCENE: ${line.replace(/\{SCENE\}/i,'').trim()}
              </div>`;
    
    const match = line.match(/^([A-Za-z0-9 .'-]+):(.*)/);
    if(match){
      const sp = match[1].trim();
      const speech = match[2].trim();
      const textColor = speakerColors[sp] || '#000';
      if(!toggled[sp])
        return `<span class="highlight" style="background:#eee; font-size:${reducedFont}px; display:block; padding:2px 4px;"><span class="speaker">${sp}:</span> ${speech}</span>`;
      
      const finalFont = (spotlighted && sp !== spotlighted) ? reducedFont : font;
      return `<span class="highlight" style="font-size:${finalFont}px; display:block; padding:2px 4px; color:${textColor};">
        <span class="speaker" style="color:${textColor}; font-weight:bold">${sp}:</span> ${speech}</span>`;
    }
    return `<span style="font-size:${font}px">${line}</span>`;
  }).join('\n');
  document.getElementById("output").innerHTML = out;
}

function toggleAllSpeakers(){
  const allOn = Object.values(toggled).every(v=>v);
  Object.keys(toggled).forEach(sp=>toggled[sp]=!allOn);
  renderSpeakerControls();
  highlightScript();
}

function copyForDocs(){
  const output = document.getElementById("output");
  const temp = document.createElement('div');
  temp.style.position = 'absolute';
  temp.style.left = '-9999px';
  temp.innerHTML = output.innerHTML;
  document.body.appendChild(temp);

  const range = document.createRange();
  range.selectNodeContents(temp);
  const sel = window.getSelection();
  sel.removeAllRanges();
  sel.addRange(range);

  try { document.execCommand('copy'); alert('Copied rich text for Docs!'); } 
  catch(e){ alert('Copy failed. Try manually selecting the text.'); }

  sel.removeAllRanges();
  document.body.removeChild(temp);
}

function copyText(){
  const out = document.getElementById("output");
  navigator.clipboard.writeText(out.innerText);
  alert("Copied plain text!");
}

function updateFontSize(val){
  document.getElementById("fontSizeVal").innerText = val;
  highlightScript();
}
</script>

</body>
</html>
