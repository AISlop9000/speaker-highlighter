<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Speaker Highlighter v3.5</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body { font-family: Arial, sans-serif; margin:20px; background:#fafafa; color:#111; }
textarea { width:100%; height:220px; font-size:16px; padding:10px; margin-bottom:10px; font-family: monospace; }
button { margin:4px; padding:8px 12px; border:none; border-radius:6px; cursor:pointer; background:#444; color:white; }
button:hover { background:#222; }
#controls { display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:10px; }
#output { white-space:pre-wrap; background:white; padding:12px; border-radius:8px; min-height:200px; overflow:auto; }
.highlight { display:block; margin:6px 0; border-radius:4px; }
.speaker { font-weight:bold; text-transform:uppercase; }
.scene { background:#efe0ff; color:#4b0082; font-weight:bold; padding:6px; border-left:6px solid #6a0dad; margin:8px 0; display:block; }
#speakerControls { margin-bottom:10px; }
</style>
</head>
<body>

<h1>ðŸŽ­ Speaker Highlighter v3.5</h1>

<textarea id="scriptInput" placeholder="Paste your script here..."></textarea>

<div id="controls">
  <button onclick="detectSpeakers()">Detect Speakers</button>
  <button onclick="highlightScript()">Highlight Speakers</button>
  <button onclick="toggleAllSpeakers()">Toggle All</button>
  <button onclick="copyForDocs()">Copy for Docs</button>
  <button onclick="copyText()">Copy Text</button>
  <button onclick="downloadPDF()">Download PDF</button>
  <label>Font size: <input id="fontSize" type="range" min="12" max="32" value="16" oninput="updateFontSize(this.value)"> <span id="fontSizeVal">16</span>pt</label>
</div>

<div id="speakerControls"></div>
<hr>
<div id="output"></div>

<script>
const speakerColors = {};
const vividColors = ['#e6194b','#3cb44b','#ffe119','#4363d8','#f58231','#911eb4','#46f0f0','#f032e6','#bcf60c','#fabebe','#008080','#e6beff','#9a6324','#fffac8','#800000'];
let detectedSpeakers = [];
let toggled = {};

document.getElementById("fontSize").addEventListener('input', e => updateFontSize(e.target.value));

function detectSpeakers(){
  const text = document.getElementById("scriptInput").value;
  const matches = [...text.matchAll(/^([A-Za-z0-9 .'-]+):/gm)];
  detectedSpeakers = [...new Set(matches.map(m => m[1].trim()))];
  renderSpeakerControls();
}

function renderSpeakerControls(){
  const div = document.getElementById("speakerControls");
  div.innerHTML = "<strong>Speakers:</strong><br>";
  detectedSpeakers.forEach((sp,i)=>{
    if(!speakerColors[sp]) speakerColors[sp]=vividColors[i % vividColors.length];
    if(toggled[sp]===undefined) toggled[sp]=true;
    div.innerHTML += `<label><input type="checkbox" data-sp="${sp}" ${toggled[sp]?'checked':''}> <span style="color:${speakerColors[sp]}">${sp}</span></label> `;
  });
  div.querySelectorAll('input[type=checkbox]').forEach(cb=>{
    cb.onchange=e=>{ toggled[e.target.dataset.sp]=e.target.checked; highlightScript(); };
  });
}

function highlightScript(){
  const text = document.getElementById("scriptInput").value;
  const lines = text.split('\n');
  const font = document.getElementById("fontSize").value;
  const out = lines.map(line=>{
    const sceneMatch = line.match(/^\{SCENE\}/i);
    if(sceneMatch) return `<span class="scene" style="font-size:${font}px">${line}</span>`;
    const match = line.match(/^([A-Za-z0-9 .'-]+):(.*)/);
    if(match){
      const sp = match[1].trim();
      const speech = match[2].trim();
      const color = speakerColors[sp]||'#ccc';
      if(!toggled[sp]) 
        return `<span class="highlight" style="background:#eee; font-size:${font}px; display:block; padding:2px 4px;"><span class="speaker">${sp}:</span> ${speech}</span>`;
      return `<span class="highlight" style="background:${color}22; font-size:${font}px; display:block; padding:2px 4px;"><span class="speaker" style="color:${color}">${sp}:</span> ${speech}</span>`;
    }
    return `<span style="font-size:${font}px">${line}</span>`;
  }).join('\n');
  document.getElementById("output").innerHTML = out;
}

function toggleAllSpeakers(){
  const allOn = Object.values(toggled).every(v=>v);
  Object.keys(toggled).forEach(sp=>toggled[sp]=!allOn);
  renderSpeakerControls();
  highlightScript();
}

function copyForDocs(){
  const output = document.getElementById("output");
  const temp = document.createElement('div');
  temp.style.position = 'absolute';
  temp.style.left = '-9999px';
  temp.innerHTML = output.innerHTML;
  document.body.appendChild(temp);

  const range = document.createRange();
  range.selectNodeContents(temp);
  const sel = window.getSelection();
  sel.removeAllRanges();
  sel.addRange(range);

  try {
    document.execCommand('copy');
    alert('Copied rich text for Docs!');
  } catch(e){
    alert('Copy failed. Try manually selecting the text.');
  }

  sel.removeAllRanges();
  document.body.removeChild(temp);
}

function copyText(){
  const out = document.getElementById("output");
  navigator.clipboard.writeText(out.innerText);
  alert("Copied plain text!");
}

function updateFontSize(val){
  document.getElementById("fontSizeVal").innerText = val;
  highlightScript();
}

function downloadPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt', format:'a4'});
  const output = document.getElementById("output").cloneNode(true);
  output.style.whiteSpace='normal';
  doc.html(output,{
    callback: function(doc){ doc.save("highlighted_script.pdf"); },
    x:20,
    y:20,
    html2canvas:{scale:2},
    margin:[20,20,20,20],
    autoPaging:true
  });
}
</script>

</body>
</html>
